#!/bin/bash

set -x
set -e

export PATH="$PATH":"`pwd`"/bin

export WORLD=$1
export SERVICE_ID=$2
export ACTIVATE=$3

terraform init -input=false -no-color tf/$WORLD
terraform --version
terraform fmt -list=true -write=false -diff=true -check=true tf/$WORLD
terraform validate -no-color tf/$WORLD
terraform import -input=false -config=tf/$WORLD -no-color fastly_service_v1.api-service-$WORLD-$SERVICE_ID $SERVICE_ID
jq --version
# we need to add the "activate" attribute manually to the state because it's not a Fastly resource and therefore it can't be imported into Terraform
jq '.resources[].instances[].attributes.activate = env.ACTIVATE' terraform.tfstate > temp && mv temp terraform.tfstate
terraform plan -input=false -out=$WORLD.plan -no-color tf/$WORLD
